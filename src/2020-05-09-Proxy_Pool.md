---
layout: post
title: 用Pyhton实现的高可用IP代理池
slug: 2020-05-09-Proxy_Pool
date: 2020-5-9 20:10
status: publish
author: Kanshan
categories: 
  - Python
tags:
  - Proxy Pool
excerpt: 这是一个Python代理池的项目。
---


1.代理池概述

##### 1.1什么是代理池

- 代理池就是代理Ip组成的池子，它可以提供稳定可用的代理IP

##### 1.2为什么要实现代理池

- 我们在做爬虫的时候，最常见的一种反爬手段，就是IP反爬，常见的解决方法就是用代理IP方案
- 代理IP非常不稳定，可用性10%可能都不到
- 从一堆不稳定的代理IP中抽取出可用代理IP，给爬虫使用。

##### 1.3代理池开发环境

- 平台：MAC,Windows,Linux

- 开发语言：Python3

- 开发工具：PyCharm

- 使用到的主要技术：

  - requests：发送请求，获取页面数据
  - lxml：使用XPATH从页面回去我们想要的数据
  - pymongo：把提取到的代理IP存储到MongoDB数据库中和从MongoDB数据库中读取代理IP给爬虫使用
  - Flask：用于提供WEB服务

  #### 

#### 2.代理池的设计

- 目标：理解代理池的工作流程和各个模块的作用
- 内容介绍
  - 代理池的工作流程
  - 代理池的模块及其作用
  - 代理池的项目结构

##### 2.1代理池的工作流程

![1587552588571](.\images\2020-5-9-1.png)



- 代理池工作流程文字描述
  - 代理IP采集模块-->采集代理IP -->如果不可用，直接过滤掉，如果可用，制定默认分数-->存入数据库
  - 代理IP检测模块-->从数据库中获取所有代理IP-->检测代理IP-->如果代理IP不可用，就把分数-1，如果的分数为0，就从数据库中删除，否则更新数据库；如果代理IP可用，则恢复为默认分值，更新数据库。
  - 代理API模块-->数据库中高可用的代理IP给爬虫使用

##### 2.2 代理模块及其作用

- 代理池分为5大核心模块
  - 爬虫模块：采集代理IP
    - 从代理IP网站上采集代理IP
    - 进行校验（获取代理响应速度，协议类型，匿名类型）
    - 把可用的代理IP存储到数据库中
  - 代理IP的检验模块：获取指定代理的响应速度，支持的协议以及匿名程度
    - 原因：网站上所标注的响应速度，协议类型是不准确的
    - 这里使用httpbin.org进行检测
  - 数据库模块：实现对代理IP的增删改查操作
    - 这里使用MongoDB来存储代理IP
  - 检测模块：定时对代理池中代理进行检测，确保代理池中代理的可用性
    -   从数据库读取所有的代理IP
    - 对代理IP进行逐一检测，可用开启多个协程，以提高检测速度
    - 如果该代理不可用，就让这个代理分数-1，当代理的分数到0了，就删除该代理，如果检测到代理可用就恢复为满分
  - 代理IP服务接口：提供高可用代理IP给爬虫使用
    - 根据协议类型和域名获取随机的高质量代理IP
    - 根据协议类型和域名获取多个高质量代理IP
    - 根据代理IP，不可用域名，告诉代理池这个代理IP在该域名下不可用，下次获取这个域名时就不会再用这个代理IP了，从而保证代理IP的高可用
  - 其他模块
    - 数据模型：domain.py
      - 代理IP的数据模型，用于封装代理IP的相关信息，如ip,端口，响应速度，协议类型，匿名类型，分数等。
    - 程序启动入口：main.py
      - 代理池提供一个统一的启动入口
    - 工具模块
      - 日志模块：用于记录日志信息
      - http模块：用于获取随机User-Agent的请求头
    - 配置文件：setting
      - 用于默认代理的分数，配置日志格式，文件，启动的爬虫，检验的时间等



##### 2.3 代理池的项目结构

![1587555736092](.\images\2020-5-9-2.png)



#### 3.实现代理池的思路

- 目标：明确代理池实现思路
- 步骤：
  - 介绍实现项目的两种思路
  - 对比两种实现思路
  - 明确代理池采用实现思路

##### 实现项目的两种思路

- 思路1：
  - 依据项目的设计流程图，一步一步进行实现
  - 遇到需要依赖于其他模块的地方，就暂停当前的模块，去实现其他模块中需要使用的功能
  - 其他模块实现后，再回来接着写当前的模块
- 思路2：
  - 先实现基础模块，这些模块不依赖于其他的模块，比如这里的：数据模型，数据库模块
  - 然后实现具体得功能模块，比如爬虫模块，检测模块，代理API模块
- 对比：
  - 思路1：按照流程一步步实现，适合一个人完成项目，流程清晰，但是不适合分工合作
  - 思路2：把项目拆分为多个相对独立的模块，每一个人实现一个模块，适合分工合作；实现项目也会更加流畅，不会有跳来跳去的现象，对最初设计要求比较高，要提前设计好后面需要用到的接口
- 代理池项目采用的实现思路
  - 这里采用 思路2来进行实现



#### 4.定义代理IP的数据模型类

- 目标：定义代理IP的数据模型类
- 步骤：
  - 定义`Proxy`类，继承object
  - 实现`__init__`方法，负责初始化，包含如下字段：
    - ip：代理的IP地址
    - port：代理IP的端口号
    - protocol：代理IP支持的协议类型，http是0，https是1，https和http都支持是2
    - nick_type：代理IP的匿名程度，高匿：0，匿名：1，透明：2
    - speed：代理IP的响应速度，单位s
    - area：代理IP所在的地区
    - score：代理IP的评分，用于衡量代理的可用性，默认分之可以通过配置文件进行配置，在进行代理可用性检查的时候，每遇到一次请求失败就减1分，减到0的时候就从池子中删除，如果检查代理可用，就恢复默认分值。
    - disable_domains：不可用域名列表，有些代理IP在某些域名下不可用，但是在其他域名下可用
  - 配置文件：`settings.py` 中定义MAX_SCORE=50，表示代理IP的默认最高分数
  - 提供`__str__`方法，返回数据字符串
- 代码

